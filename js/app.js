// ========== –ü–ï–†–ï–í–û–î–´ ==========
const translations = {
    kk: {
        title: "“∞–ë–¢ –®—Ç—É—Ä–º",
        logo_title: "‚ôü “∞–ë–¢-—à—Ç—É—Ä–º",
        nav_home: "–ë–∞—Å—Ç—ã –±–µ—Ç",
        nav_rating: "–†–µ–π—Ç–∏–Ω–≥",
        welcome_title: "“ö–æ—à –∫–µ–ª–¥—ñ“£—ñ–∑!",
        welcome_subtitle: "–¢–µ—Å—Ç—ñ–ª–µ—É–¥—ñ –±–∞—Å—Ç–∞—É “Ø—à—ñ–Ω –º”ô–ª—ñ–º–µ—Ç—Ç–µ—Ä—ñ“£—ñ–∑–¥—ñ –µ–Ω–≥—ñ–∑—ñ“£—ñ–∑",
        fio_label: "–¢–æ–ª—ã“õ –∞—Ç—ã-–∂”©–Ω—ñ“£—ñ–∑ (–§–ò–û)",
        iin_label: "–ò–ò–ù (12 —Ü–∏—Ñ—Ä–∞)",
        language_label: "–¢–µ—Å—Ç—ñ–ª–µ—É —Ç—ñ–ª—ñ",
        lang_kk: "“ö–∞–∑–∞“õ—à–∞",
        lang_ru: "–†—É—Å—Å–∫–∏–π",
        continue: "–ñ–∞–ª“ì–∞—Å—Ç—ã—Ä—É",
        subjects_title: "–¢–∞“õ—ã—Ä—ã–ø—Ç–∞—Ä–¥—ã —Ç–∞“£–¥–∞“£—ã–∑",
        subjects_subtitle: "–ë—ñ—Ä –Ω–µ–º–µ—Å–µ –±—ñ—Ä–Ω–µ—à–µ —Ç–∞“õ—ã—Ä—ã–ø—Ç—ã –±–µ–ª–≥—ñ–ª–µ“£—ñ–∑",
        no_subjects: "“ö–æ–ª–∂–µ—Ç—ñ–º–¥—ñ —Ç–∞“õ—ã—Ä—ã–ø—Ç–∞—Ä –∂–æ“õ",
        start_quiz: "–¢–µ—Å—Ç—ñ–ª–µ—É–¥—ñ –±–∞—Å—Ç–∞—É",
        player_name: "–û–π—ã–Ω—à—ã:",
        streak: "–°—Ç—Ä–∏–∫",
        lives: "”®–º—ñ—Ä",
        correct: "–î“±—Ä—ã—Å! üî•",
        wrong: "“ö–∞—Ç–µ üòî",
        correct_answer: "–î“±—Ä—ã—Å –∂–∞—É–∞–ø:",
        explanation: "–¢“Ø—Å—ñ–Ω–¥—ñ—Ä–º–µ:",
        source: "–î–µ—Ä–µ–∫–∫”©–∑:",
        next_question: "–ö–µ–ª–µ—Å—ñ —Å“±—Ä–∞“õ",
        rating_title: "–†–µ–π—Ç–∏–Ω–≥",
        rating_subtitle: "–û–π—ã–Ω—à—ã–ª–∞—Ä–¥—ã“£ “Ø–∑–¥—ñ–∫ –Ω”ô—Ç–∏–∂–µ–ª–µ—Ä—ñ",
        filter_all: "–ñ–∞–ª–ø—ã",
        filter_subject: "–ü”ô–Ω –±–æ–π—ã–Ω—à–∞",
        table_rank: "#",
        table_name: "–û–π—ã–Ω—à—ã",
        table_subject: "–ü”ô–Ω",
        table_score: "–°—Ç—Ä–∏–∫",
        table_time: "–£–∞“õ—ã—Ç",
        session_time: "—Å–µ–∫.",
        no_records: "”ò–∑—ñ—Ä—à–µ —Ä–µ–∫–æ—Ä–¥—Ç–∞—Ä –∂–æ“õ",
        rating_button: "–†–µ–π—Ç–∏–Ω–≥ –∫”©—Ä—É",
        game_over: "–û–π—ã–Ω –∞—è“õ—Ç–∞–ª–¥—ã!",
        max_streak: "–ú–∞–∫—Å–∏–º–∞–ª–¥—ã —Å—Ç—Ä–∏–∫:",
        lives_left: "“ö–∞–ª“ì–∞–Ω ”©–º—ñ—Ä:",
        current_streak: "–ê“ì—ã–º–¥–∞“ì—ã —Å—Ç—Ä–∏–∫:",
        questions_finished: "–°“±—Ä–∞“õ—Ç–∞—Ä –∞—è“õ—Ç–∞–ª–¥—ã!",
        answered_all: "–°—ñ–∑ –±–∞—Ä–ª—ã“õ —Å“±—Ä–∞“õ—Ç–∞—Ä–¥—ã –∂–∞—É–∞–ø—Ç–∞–¥—ã“£—ã–∑!",
        final_streak: "–°–æ“£“ì—ã —Å—Ç—Ä–∏–∫:"
    },
    ru: {
        title: "–ï–ù–¢ –®—Ç—É—Ä–º",
        logo_title: "‚ôü –ï–ù–¢-—à—Ç—É—Ä–º",
        nav_home: "–ì–ª–∞–≤–Ω–∞—è",
        nav_rating: "–†–µ–π—Ç–∏–Ω–≥",
        welcome_title: "–î–æ–±—Ä–æ –ø–æ–∂–∞–ª–æ–≤–∞—Ç—å!",
        welcome_subtitle: "–í–≤–µ–¥–∏—Ç–µ —Å–≤–æ–∏ –¥–∞–Ω–Ω—ã–µ –¥–ª—è –Ω–∞—á–∞–ª–∞ —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è",
        fio_label: "–§–ò–û –ø–æ–ª–Ω–æ—Å—Ç—å—é",
        iin_label: "–ò–ò–ù (12 —Ü–∏—Ñ—Ä)",
        language_label: "–Ø–∑—ã–∫ —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è",
        lang_kk: "“ö–∞–∑–∞“õ—à–∞",
        lang_ru: "–†—É—Å—Å–∫–∏–π",
        continue: "–ü—Ä–æ–¥–æ–ª–∂–∏—Ç—å",
        subjects_title: "–í—ã–±–µ—Ä–∏—Ç–µ –ø—Ä–µ–¥–º–µ—Ç—ã",
        subjects_subtitle: "–û—Ç–º–µ—Ç—å—Ç–µ –æ–¥–∏–Ω –∏–ª–∏ –Ω–µ—Å–∫–æ–ª—å–∫–æ –ø—Ä–µ–¥–º–µ—Ç–æ–≤",
        no_subjects: "–î–æ—Å—Ç—É–ø–Ω—ã—Ö –ø—Ä–µ–¥–º–µ—Ç–æ–≤ –Ω–µ—Ç",
        start_quiz: "–ù–∞—á–∞—Ç—å —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ",
        player_name: "–ò–≥—Ä–æ–∫:",
        streak: "–°—Ç—Ä–∏–∫",
        lives: "–ñ–∏–∑–Ω–∏",
        correct: "–ü—Ä–∞–≤–∏–ª—å–Ω–æ! üî•",
        wrong: "–ù–µ–ø—Ä–∞–≤–∏–ª—å–Ω–æ üòî",
        correct_answer: "–ü—Ä–∞–≤–∏–ª—å–Ω—ã–π –æ—Ç–≤–µ—Ç:",
        explanation: "–û–±—ä—è—Å–Ω–µ–Ω–∏–µ:",
        source: "–ò—Å—Ç–æ—á–Ω–∏–∫:",
        next_question: "–°–ª–µ–¥—É—é—â–∏–π –≤–æ–ø—Ä–æ—Å",
        rating_title: "–†–µ–π—Ç–∏–Ω–≥",
        rating_subtitle: "–õ—É—á—à–∏–µ —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã –∏–≥—Ä–æ–∫–æ–≤",
        filter_all: "–û–±—â–∏–π",
        filter_subject: "–ü–æ –ø—Ä–µ–¥–º–µ—Ç—É",
        table_rank: "#",
        table_name: "–ò–≥—Ä–æ–∫",
        table_subject: "–ü—Ä–µ–¥–º–µ—Ç",
        table_score: "–°—Ç—Ä–∏–∫",
        table_time: "–í—Ä–µ–º—è",
        session_time: "—Å–µ–∫.",
        no_records: "–ü–æ–∫–∞ –Ω–µ—Ç —Ä–µ–∫–æ—Ä–¥–æ–≤",
        rating_button: "–ü–æ—Å–º–æ—Ç—Ä–µ—Ç—å —Ä–µ–π—Ç–∏–Ω–≥",
        game_over: "–ò–≥—Ä–∞ –æ–∫–æ–Ω—á–µ–Ω–∞!",
        max_streak: "–ú–∞–∫—Å–∏–º–∞–ª—å–Ω—ã–π —Å—Ç—Ä–∏–∫:",
        lives_left: "–û—Å—Ç–∞–ª–æ—Å—å –∂–∏–∑–Ω–µ–π:",
        current_streak: "–¢–µ–∫—É—â–∏–π —Å—Ç—Ä–∏–∫:",
        questions_finished: "–í–æ–ø—Ä–æ—Å—ã –∑–∞–∫–æ–Ω—á–∏–ª–∏—Å—å!",
        answered_all: "–í—ã –æ—Ç–≤–µ—Ç–∏–ª–∏ –Ω–∞ –≤—Å–µ –≤–æ–ø—Ä–æ—Å—ã!",
        final_streak: "–§–∏–Ω–∞–ª—å–Ω—ã–π —Å—Ç—Ä–∏–∫:"
    }
};

// ========== –ì–õ–û–ë–ê–õ–¨–ù–´–ï –ü–ï–†–ï–ú–ï–ù–ù–´–ï ==========
let currentLang = "ru";
let currentPage = "home";
let selectedSubjects = [];
let availableSubjects = [];
let allQuestions = [];
let questionQueue = [];
let streak = 0;
let maxStreakThisSession = 0;
let gameStartTime = 0;
let records = [];
let currentQuestionData = null;
let lives = 3;
let maxLives = 3;

const subjects = [
    { id: "biologiya", name_kk: "–ë–∏–æ–ª–æ–≥–∏—è", name_ru: "–ë–∏–æ–ª–æ–≥–∏—è" },
    { id: "geografiya", name_kk: "–ì–µ–æ–≥—Ä–∞—Ñ–∏—è", name_ru: "–ì–µ–æ–≥—Ä–∞—Ñ–∏—è" },
    { id: "qazaqstan-taryhy", name_kk: "“ö–∞–∑–∞“õ—Å—Ç–∞–Ω —Ç–∞—Ä–∏—Ö—ã", name_ru: "–ò—Å—Ç–æ—Ä–∏—è –ö–∞–∑–∞—Ö—Å—Ç–∞–Ω–∞" },
    { id: "matematika", name_kk: "–ú–∞—Ç–µ–º–∞—Ç–∏–∫–∞", name_ru: "–ú–∞—Ç–µ–º–∞—Ç–∏–∫–∞" },
    { id: "fizika", name_kk: "–§–∏–∑–∏–∫–∞", name_ru: "–§–∏–∑–∏–∫–∞" },
    { id: "himiya", name_kk: "–•–∏–º–∏—è", name_ru: "–•–∏–º–∏—è" },
    { id: "informatika", name_kk: "–ò–Ω—Ñ–æ—Ä–º–∞—Ç–∏–∫–∞", name_ru: "–ò–Ω—Ñ–æ—Ä–º–∞—Ç–∏–∫–∞" }
];

// ========== –£–¢–ò–õ–ò–¢–´ ==========
function shuffleArray(array) {
    const shuffled = [...array];
    for (let i = shuffled.length - 1; i > 0; i--) {
        const j = Math.floor(Math.random() * (i + 1));
        [shuffled[i], shuffled[j]] = [shuffled[j], shuffled[i]];
    }
    return shuffled;
}

function shuffleOptions(options, correctIndex) {
    const indexed = options.map((option, index) => ({
        text: option,
        wasCorrect: index === correctIndex
    }));
    const shuffled = shuffleArray(indexed);
    const newCorrectIndex = shuffled.findIndex(opt => opt.wasCorrect);
    return {
        options: shuffled.map(opt => opt.text),
        correctIndex: newCorrectIndex
    };
}

function updateLivesDisplay() {
    const container = document.getElementById('lives-count');
    if (!container) return;
    container.innerHTML = '';
    for (let i = 0; i < maxLives; i++) {
        const heart = document.createElement('span');
        heart.style.fontSize = '1.5rem';
        heart.style.transition = 'transform 0.3s ease';
        if (i < lives) {
            heart.textContent = '‚ù§Ô∏è';
            heart.style.animation = 'heartbeat 1s ease infinite';
        } else {
            heart.textContent = 'üñ§';
            heart.style.opacity = '0.3';
        }
        container.appendChild(heart);
    }
}

// ========== –ù–ê–í–ò–ì–ê–¶–ò–Ø ==========
function navigateTo(page) {
    currentPage = page;

    // –°–∫—Ä—ã–≤–∞–µ–º –≤—Å–µ —Å–µ–∫—Ü–∏–∏
    document.querySelectorAll('.page-section').forEach(s => s.classList.add('hidden'));

    // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –Ω—É–∂–Ω—É—é —Å–µ–∫—Ü–∏—é
    const pageMap = {
        'home': 'welcome-screen',
        'rating': 'rating-screen'
    };

    const sectionId = pageMap[page];
    if (sectionId) {
        document.getElementById(sectionId).classList.remove('hidden');
    }

    // –û–±–Ω–æ–≤–ª—è–µ–º –∞–∫—Ç–∏–≤–Ω—É—é –∫–Ω–æ–ø–∫—É –≤ –º–µ–Ω—é
    document.querySelectorAll('.nav-link').forEach(link => {
        if (link.dataset.page === page) {
            link.classList.add('active');
        } else {
            link.classList.remove('active');
        }
    });

    // –ï—Å–ª–∏ –æ—Ç–∫—Ä—ã–≤–∞–µ–º —Ä–µ–π—Ç–∏–Ω–≥ - –∑–∞–≥—Ä—É–∂–∞–µ–º –¥–∞–Ω–Ω—ã–µ
    if (page === 'rating') {
        loadRating();
    }
}

// ========== –ü–ï–†–ï–í–û–î–´ ==========
function setLanguage(lang) {
    currentLang = lang;
    document.documentElement.lang = lang;

    document.querySelectorAll('[data-key]').forEach(el => {
        const key = el.dataset.key;
        if (translations[lang][key]) {
            if (el.tagName === 'INPUT' || el.tagName === 'TEXTAREA') {
                el.placeholder = translations[lang][key];
            } else {
                el.textContent = translations[lang][key];
            }
        }
    });

    // –û–±–Ω–æ–≤–ª—è–µ–º –∞–∫—Ç–∏–≤–Ω—É—é –∫–Ω–æ–ø–∫—É —è–∑—ã–∫–∞ –≤ —Ñ–æ—Ä–º–µ
    document.querySelectorAll('.lang-btn-form').forEach(btn => {
        btn.classList.toggle('active', btn.dataset.lang === lang);
    });

    if (!document.getElementById('subjects-screen').classList.contains('hidden')) {
        renderSubjects();
    }
}

// ========== –ü–†–ï–î–ú–ï–¢–´ ==========
async function loadAvailableSubjects() {
    availableSubjects = [];
    for (const sub of subjects) {
        try {
            const res = await fetch(`data/${sub.id}.json`);
            if (!res.ok) continue;
            const data = await res.json();
            if (!Array.isArray(data)) continue;
            const filtered = data.filter(q => q.lang === currentLang || !q.lang);
            if (filtered.length > 0) {
                availableSubjects.push({ ...sub, questionCount: filtered.length });
            }
        } catch (e) {
            console.error(`–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ ${sub.id}:`, e);
        }
    }
    renderSubjects();
}

function renderSubjects() {
    const grid = document.getElementById('subjects-grid');
    if (!grid) return;
    grid.innerHTML = '';

    if (availableSubjects.length === 0) {
        grid.innerHTML = `<p style="text-align:center;color:var(--text-muted);font-size:1.2rem;">
${translations[currentLang].no_subjects}</p>`;
        document.getElementById('start-quiz-btn').disabled = true;
        return;
    }

    availableSubjects.forEach(sub => {
        const div = document.createElement('div');
        div.className = 'subject-item';
        div.dataset.id = sub.id;
        div.innerHTML = `<span>${sub[`name_${currentLang}`]}<br><small style="opacity:0.7;">(${sub.questionCount})</small></span>`;
        div.onclick = () => {
            div.classList.toggle('selected');
            const sel = Array.from(document.querySelectorAll('.subject-item.selected')).map(el => el.dataset.id);
            document.getElementById('start-quiz-btn').disabled = sel.length === 0;
        };
        grid.appendChild(div);
    });
}

// ========== –í–û–ü–†–û–°–´ ==========
async function loadQuestionsFromSelected() {
    allQuestions = [];
    const selectedIds = Array.from(document.querySelectorAll('.subject-item.selected')).map(el => el.dataset.id);
    selectedSubjects = selectedIds.map(id => {
        const subject = subjects.find(s => s.id === id);
        return subject ? subject[`name_${currentLang}`] : id;
    });

    for (const id of selectedIds) {
        try {
            const res = await fetch(`data/${id}.json`);
            if (res.ok) {
                const data = await res.json();
                if (Array.isArray(data)) {
                    const filtered = data.filter(q => q.lang === currentLang || !q.lang);
                    allQuestions.push(...filtered);
                }
            }
        } catch (e) {
            console.error(`–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ ${id}:`, e);
        }
    }

    if (allQuestions.length > 0) {
        questionQueue = allQuestions.map((_, index) => index);
        questionQueue = shuffleArray(questionQueue);
    }

    return allQuestions.length > 0;
}

function showRandomQuestion() {
    if (questionQueue.length === 0) {
        const feedback = document.getElementById('feedback');
        feedback.innerHTML = `
            <div style="text-align:center; padding:2rem;">
                <div style="font-size:3rem; margin-bottom:1rem;">üéâ</div>
                <h2 style="color:var(--accent); margin-bottom:1rem;">${translations[currentLang].questions_finished}</h2>
                <p style="font-size:1.2rem; margin-bottom:1rem;">${translations[currentLang].answered_all}</p>
                <div style="font-size:1.5rem; color:var(--accent); margin-bottom:2rem;">
                    ${translations[currentLang].final_streak} <strong style="font-size:2rem;">${streak}</strong> üî•
                </div>
            </div>
        `;
        feedback.className = 'feedback correct';
        feedback.classList.remove('hidden');

        const ratingBtn = document.createElement('button');
        ratingBtn.className = 'btn-primary';
        ratingBtn.textContent = translations[currentLang].rating_button;
        ratingBtn.onclick = () => navigateTo('rating');
        feedback.appendChild(ratingBtn);

        saveRecord();
        return;
    }

    const questionIndex = questionQueue.shift();
    const q = allQuestions[questionIndex];
    currentQuestionData = q;

    document.getElementById('feedback').classList.add('hidden');
    document.getElementById('next-question').classList.add('hidden');
    document.getElementById('question-text').textContent = q.id + ': \n' + q.question;

    // –ò–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ
    const imgCont = document.getElementById('question-image');
    imgCont.innerHTML = '';
    if (q.image && q.image.trim()) {
        const img = document.createElement('img');
        img.src = q.image.trim();
        img.alt = translations[currentLang].question;
        img.style.maxWidth = '100%';
        img.style.borderRadius = '12px';
        img.onerror = () => {
            imgCont.innerHTML = `<p style="color:#ef4444; text-align:center;">–ò–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ –Ω–µ –Ω–∞–π–¥–µ–Ω–æ</p>`;
        };
        imgCont.appendChild(img);
        imgCont.classList.remove('hidden');
    } else {
        imgCont.classList.add('hidden');
    }

    // –í–∞—Ä–∏–∞–Ω—Ç—ã
    const shuffled = shuffleOptions(q.options, q.correct);
    const opts = document.getElementById('options-container');
    opts.innerHTML = '';
    shuffled.options.forEach((opt, i) => {
        const btn = document.createElement('button');
        btn.className = 'option-btn';
        btn.textContent = opt;
        btn.onclick = () => checkAnswer(i, shuffled.correctIndex, shuffled.options);
        opts.appendChild(btn);
    });
}

function checkAnswer(selectedIdx, correctIdx, shuffledOptions) {
    const opts = document.querySelectorAll('.option-btn');
    const feedback = document.getElementById('feedback');
    feedback.classList.remove('hidden');
    opts.forEach(btn => btn.disabled = true);

    if (selectedIdx === correctIdx) {
        streak++;
        if (streak > maxStreakThisSession) maxStreakThisSession = streak;
        document.getElementById('streak-count').textContent = streak;
        opts[selectedIdx].classList.add('correct');

        feedback.innerHTML = `<strong>${translations[currentLang].correct}</strong>`;
        if (currentQuestionData.explanation) {
            feedback.innerHTML += `<br><br><strong>${translations[currentLang].explanation}</strong> ${currentQuestionData.explanation}`;
        }
        if (currentQuestionData.source) {
            feedback.innerHTML += `<br><br><strong>${translations[currentLang].source}</strong> ${currentQuestionData.source}`;
        }
        feedback.className = 'feedback correct';
        document.getElementById('next-question').classList.remove('hidden');
    } else {
        lives--;
        updateLivesDisplay();
        opts[selectedIdx].classList.add('wrong');
        opts[correctIdx].classList.add('correct');

        feedback.innerHTML = `<strong>${translations[currentLang].wrong}</strong><br><br>
<strong>${translations[currentLang].correct_answer}</strong> ${shuffledOptions[correctIdx]}<br><br>`;

        if (currentQuestionData.explanation) {
            feedback.innerHTML += `<strong>${translations[currentLang].explanation}</strong> ${currentQuestionData.explanation}<br><br>`;
        }
        if (currentQuestionData.source) {
            feedback.innerHTML += `<strong>${translations[currentLang].source}</strong> ${currentQuestionData.source}<br><br>`;
        }
        feedback.className = 'feedback wrong';

        if (lives <= 0) {
            streak = 0;
            document.getElementById('streak-count').textContent = 0;
            feedback.innerHTML += `<div style="margin-top:1.5rem; padding:1rem; background:rgba(239,68,68,0.15); border-radius:12px; border:2px solid var(--error);">
                <strong style="font-size:1.3rem;">üíî ${translations[currentLang].game_over}</strong><br><br>
                ${translations[currentLang].max_streak} <strong>${maxStreakThisSession}</strong>
            </div>`;

            const ratingBtn = document.createElement('button');
            ratingBtn.className = 'btn-primary';
            ratingBtn.style.marginTop = '1.5rem';
            ratingBtn.textContent = translations[currentLang].rating_button;
            ratingBtn.onclick = () => navigateTo('rating');
            feedback.appendChild(ratingBtn);
            saveRecord();
        } else {
            document.getElementById('next-question').classList.remove('hidden');
            feedback.innerHTML += `<div style="margin-top:1rem; padding:1rem; background:var(--accent-light); border-radius:8px; border:1px solid var(--accent);">
                <div style="color:var(--text-muted); margin-bottom:0.5rem;">
                    ${translations[currentLang].lives_left} <strong style="color:var(--error); font-size:1.3rem;">${lives}</strong>
                </div>
                <div style="color:var(--accent); font-size:1.1rem;">
                    üí™ ${translations[currentLang].current_streak} <strong style="font-size:1.3rem;">${streak}</strong> üî•
                </div>
            </div>`;
        }
    }
}

// ========== –†–ï–ö–û–†–î–´ ==========
function saveRecord() {
    const timeSec = Math.round((Date.now() - gameStartTime) / 1000);
    const user = JSON.parse(localStorage.getItem('quizUser')) || { fio: '–ê–Ω–æ–Ω–∏–º' };
    const subjectsText = selectedSubjects.length > 0 ? selectedSubjects.join(', ') : '–û–±—â–∏–π';

    const record = {
        fio: user.fio || '–ê–Ω–æ–Ω–∏–º',
        streak: maxStreakThisSession,
        time: timeSec,
        date: new Date().toLocaleString(currentLang === 'kk' ? 'kk-KZ' : 'ru-RU'),
        subject: subjectsText
    };

    fetch('/records', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(record)
    })
        .then(res => res.json())
        .then(data => { records = data.records || []; })
        .catch(err => console.error('–û—à–∏–±–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è:', err));
}

function loadRating() {
    fetch('/records')
        .then(res => res.json())
        .then(data => {
            records = data || [];

            // –°–æ–∑–¥–∞–µ–º –∫–Ω–æ–ø–∫–∏ –ø—Ä–µ–¥–º–µ—Ç–æ–≤
            createSubjectButtons();

            // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –æ–±—â–∏–π —Ä–µ–π—Ç–∏–Ω–≥
            renderRating(records);
        })
        .catch(err => {
            console.error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ —Ä–µ–π—Ç–∏–Ω–≥–∞:', err);
            renderRating([]);
        });
}

function createSubjectButtons() {
    const subjectFilters = document.getElementById('subject-filters');
    const mainFilters = document.getElementById('main-filters');

    if (!subjectFilters || !mainFilters) return;

    // –°–æ–±–∏—Ä–∞–µ–º —É–Ω–∏–∫–∞–ª—å–Ω—ã–µ –ø—Ä–µ–¥–º–µ—Ç—ã –∏–∑ —Ä–µ–∫–æ—Ä–¥–æ–≤
    const subjectsSet = new Set();
    records.forEach(r => {
        if (r.subject) subjectsSet.add(r.subject);
    });

    // –ï—Å–ª–∏ –µ—Å—Ç—å –ø—Ä–µ–¥–º–µ—Ç—ã, –ø–æ–∫–∞–∑—ã–≤–∞–µ–º –∫–Ω–æ–ø–∫–∏
    if (subjectsSet.size > 0) {
        subjectFilters.innerHTML = '';
        subjectFilters.classList.remove('hidden');

        subjectsSet.forEach(subject => {
            const btn = document.createElement('button');
            btn.className = 'filter-btn';
            btn.dataset.subject = subject;

            // –ò–∫–æ–Ω–∫–∏ –¥–ª—è –ø—Ä–µ–¥–º–µ—Ç–æ–≤
            const icons = {
                '–ò–Ω—Ñ–æ—Ä–º–∞—Ç–∏–∫–∞': 'üíª',
                'Informatika': 'üíª',
                '–ú–∞—Ç–µ–º–∞—Ç–∏–∫–∞': 'üìê',
                'Matematika': 'üìê',
                '–§–∏–∑–∏–∫–∞': '‚öõÔ∏è',
                'Fizika': '‚öõÔ∏è',
                '–•–∏–º–∏—è': 'üß™',
                'Himiya': 'üß™',
                '–ë–∏–æ–ª–æ–≥–∏—è': 'üß¨',
                'Biologiya': 'üß¨',
                '–ì–µ–æ–≥—Ä–∞—Ñ–∏—è': 'üåç',
                'Geografiya': 'üåç',
                '–ò—Å—Ç–æ—Ä–∏—è': 'üìú'
            };

            const icon = Object.keys(icons).find(key => subject.includes(key));
            const iconEmoji = icon ? icons[icon] : 'üìö';

            btn.innerHTML = `
                <span class="filter-icon">${iconEmoji}</span>
                <span>${subject}</span>
            `;

            btn.onclick = () => {
                // –°–Ω–∏–º–∞–µ–º –∞–∫—Ç–∏–≤–Ω–æ—Å—Ç—å —Å "–û–±—â–∏–π"
                mainFilters.querySelectorAll('.filter-btn').forEach(b => b.classList.remove('active'));
                // –°–Ω–∏–º–∞–µ–º –∞–∫—Ç–∏–≤–Ω–æ—Å—Ç—å —Å –¥—Ä—É–≥–∏—Ö –ø—Ä–µ–¥–º–µ—Ç–æ–≤
                subjectFilters.querySelectorAll('.filter-btn').forEach(b => b.classList.remove('active'));
                // –ê–∫—Ç–∏–≤–∏—Ä—É–µ–º —Ç–µ–∫—É—â—É—é –∫–Ω–æ–ø–∫—É
                btn.classList.add('active');

                // –§–∏–ª—å—Ç—Ä—É–µ–º —Ä–µ–π—Ç–∏–Ω–≥
                const filtered = records.filter(r => r.subject === subject);
                renderRating(filtered);
            };

            subjectFilters.appendChild(btn);
        });
    } else {
        subjectFilters.classList.add('hidden');
    }
}

function renderRating(data) {
    const tbody = document.getElementById('rating-tbody');
    const empty = document.getElementById('rating-empty');

    if (data.length === 0) {
        tbody.innerHTML = '';
        empty.classList.remove('hidden');
        return;
    }

    empty.classList.add('hidden');
    tbody.innerHTML = '';

    data.forEach((record, index) => {
        const tr = document.createElement('tr');

        let medal = '';
        if (index === 0) medal = 'ü•á';
        else if (index === 1) medal = 'ü•à';
        else if (index === 2) medal = 'ü•â';

        tr.innerHTML = `
            <td class="col-rank"><span class="rank-medal">${medal}</span>${index + 1}</td>
            <td class="col-name">${record.fio}</td>
            <td class="col-subject">${record.subject}</td>
            <td class="col-score">${record.streak} üî•</td>
            <td class="col-time">${record.time} ${translations[currentLang].session_time}</td>
        `;
        tbody.appendChild(tr);
    });
}

// ========== –ò–ù–ò–¶–ò–ê–õ–ò–ó–ê–¶–ò–Ø ==========
document.addEventListener('DOMContentLoaded', () => {
    // –Ø–∑—ã–∫
    const savedLang = localStorage.getItem('quizLang') || 'ru';
    setLanguage(savedLang);

    // –¢–µ–º–∞
    const savedTheme = localStorage.getItem('theme') || 'dark';
    document.body.setAttribute('data-theme', savedTheme);
    const themeSwitch = document.getElementById('theme-switch');
    if (themeSwitch) themeSwitch.checked = savedTheme === 'light';

    // –ù–∞–≤–∏–≥–∞—Ü–∏—è
    document.querySelectorAll('.nav-link').forEach(link => {
        link.addEventListener('click', () => navigateTo(link.dataset.page));
    });

    // –ö–ª–∏–∫ –ø–æ –ª–æ–≥–æ—Ç–∏–ø—É
    document.querySelector('.nav-logo').addEventListener('click', () => {
        location.reload();
    });

    // –ü–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏–µ —Ç–µ–º—ã
    if (themeSwitch) {
        themeSwitch.addEventListener('change', () => {
            const theme = themeSwitch.checked ? 'light' : 'dark';
            document.body.setAttribute('data-theme', theme);
            localStorage.setItem('theme', theme);
        });
    }

    // –ü–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏–µ —è–∑—ã–∫–∞ –≤ —Ñ–æ—Ä–º–µ
    document.querySelectorAll('.lang-btn-form').forEach(btn => {
        btn.addEventListener('click', () => {
            setLanguage(btn.dataset.lang);
            localStorage.setItem('quizLang', currentLang);
        });
    });

    // –§–æ—Ä–º–∞ –≤—Ö–æ–¥–∞
    document.getElementById('user-form')?.addEventListener('submit', e => {
        e.preventDefault();
        const fio = document.getElementById('fio')?.value.trim();
        const iin = document.getElementById('iin')?.value.trim();

        if (!fio || iin.length !== 12 || !/^\d{12}$/.test(iin)) {
            alert(currentLang === 'kk' ? "–¢–æ–ª—ã“õ –∂”ô–Ω–µ –¥“±—Ä—ã—Å –º”ô–ª—ñ–º–µ—Ç—Ç–µ—Ä–¥—ñ –µ–Ω–≥—ñ–∑—ñ“£—ñ–∑" : "–í–≤–µ–¥–∏—Ç–µ –ø–æ–ª–Ω—ã–µ –∏ –ø—Ä–∞–≤–∏–ª—å–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ");
            return;
        }

        localStorage.setItem('quizUser', JSON.stringify({ fio, iin, lang: currentLang }));
        document.getElementById('welcome-screen')?.classList.add('hidden');
        document.getElementById('subjects-screen')?.classList.remove('hidden');
        loadAvailableSubjects();
    });

    // –°—Ç–∞—Ä—Ç –≤–∏–∫—Ç–æ—Ä–∏–Ω—ã
    document.getElementById('start-quiz-btn')?.addEventListener('click', async () => {
        const hasQuestions = await loadQuestionsFromSelected();
        if (!hasQuestions) {
            alert(currentLang === 'kk' ? "–¢–∞“£–¥–∞–ª“ì–∞–Ω —Ç–∞“õ—ã—Ä—ã–ø—Ç–∞—Ä–¥–∞ —Å“±—Ä–∞“õ—Ç–∞—Ä –∂–æ“õ" : "–í –≤—ã–±—Ä–∞–Ω–Ω—ã—Ö –ø—Ä–µ–¥–º–µ—Ç–∞—Ö –Ω–µ—Ç –≤–æ–ø—Ä–æ—Å–æ–≤");
            return;
        }

        streak = 0;
        maxStreakThisSession = 0;
        lives = 3;
        gameStartTime = Date.now();
        document.getElementById('streak-count').textContent = 0;

        const user = JSON.parse(localStorage.getItem('quizUser')) || { fio: '–ê–Ω–æ–Ω–∏–º' };
        document.getElementById('player-name').textContent = user.fio || '–ê–Ω–æ–Ω–∏–º';
        updateLivesDisplay();

        document.getElementById('subjects-screen')?.classList.add('hidden');
        document.getElementById('game-screen')?.classList.remove('hidden');
        showRandomQuestion();
    });

    // –°–ª–µ–¥—É—é—â–∏–π –≤–æ–ø—Ä–æ—Å
    document.getElementById('next-question')?.addEventListener('click', showRandomQuestion);

    // –§–∏–ª—å—Ç—Ä—ã —Ä–µ–π—Ç–∏–Ω–≥–∞ - –∫–Ω–æ–ø–∫–∞ "–û–±—â–∏–π"
    document.querySelectorAll('#main-filters .filter-btn').forEach(btn => {
        btn.addEventListener('click', () => {
            // –°–Ω–∏–º–∞–µ–º –∞–∫—Ç–∏–≤–Ω–æ—Å—Ç—å —Å–æ –≤—Å–µ—Ö –∫–Ω–æ–ø–æ–∫
            document.querySelectorAll('.filter-btn').forEach(b => b.classList.remove('active'));
            // –ê–∫—Ç–∏–≤–∏—Ä—É–µ–º "–û–±—â–∏–π"
            btn.classList.add('active');
            // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –≤—Å–µ —Ä–µ–∫–æ—Ä–¥—ã
            renderRating(records);
        });
    });

    document.getElementById('subject-filter')?.addEventListener('change', updateSubjectFilter);

    loadAvailableSubjects();
});